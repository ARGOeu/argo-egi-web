<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd"
        xmlns:date="http://exslt.org/dates-and-times"
        xmlns:xi="http://www.w3.org/2001/XInclude"
        xmlns:str="http://exslt.org/strings"
        xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
    <!--<view name="ngi_daily_results">-->
        <!--<info>-->
            <!--<category>API calls</category>-->
            <!--<description>NGI Availability in Profile - Daily option - key : profile</description>-->
        <!--</info>-->




        <!--<connector type="XMLConnector">-->
            <!--<parameter name="content" eval="view('listProfilesRaw')"></parameter>-->
        <!--</connector>-->


        <!--<processors>-->
            <!--<insert match="/root/profile">-->
                <!--<connector type="XMLConnector">-->
                    <!--<parameter name="content" eval="view('ngi_daily_resultsByProfile',entry('profile',concat(parent_match()/@namespace,'-',parent_match()/@name)))"></parameter>-->

                <!--</connector>-->
            <!--</insert>-->
            <!--<remove match="/root/profile/AND"></remove>-->

        <!--</processors>-->



        <!--<cache type="FileCache">-->
            <!--&lt;!&ndash;<trigger type="ViewCreatedTrigger"/>&ndash;&gt;-->
            <!--<trigger type="DeltaTimeTrigger">-->
                <!--<parameter name="minutes">20</parameter>-->
            <!--</trigger>-->
            <!--<trigger type="ViewNotifiedTrigger"/>-->
            <!--<trigger type="ViewCreatedTrigger"/>-->
        <!--</cache>-->

    <!--</view>-->

    <view name="group_availability_results">
        <info>
            <category>API calls</category>
            <description>Availability in Profile - All options - No Profile</description>
        </info>

        <argument name="group_type"></argument>
        <argument name="start_time"></argument>
        <argument name="end_time"></argument>
        <argument name="granularity"></argument>
        <argument name="availability_profile"></argument>
        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('api.group.availability'),
            '&amp;granularity=',$granularity,'&amp;group_type=',$group_type,
            '&amp;start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;availability_profile=',$availability_profile)">
            </parameter>
        </connector>

        <processors>
            <!--<remove match="/root/Profile/*/Availability[not(contains(@timestamp,substring($start_time,0,8)))]"></remove>-->
        </processors>

    </view>
    <view name="services_availability_results">
        <info>
            <category>API calls</category>
            <description>Service Availability in Profile - All options - No Profile</description>
        </info>


        <argument name="start_time"></argument>
        <argument name="end_time"></argument>
        <argument name="granularity"></argument>
        <argument name="availability_profile"></argument>

        <connector type="HTTPConnector">
            <parameter name="url" eval="concat(property('api.service.availability'),
            '&amp;granularity=',$granularity,
            '&amp;start_time=',$start_time,'&amp;end_time=',$end_time,'&amp;profile=',$availability_profile)">
            </parameter>
        </connector>

        <processors>
            <!--<remove match="/root/Profile/*/Availability[not(contains(@timestamp,substring($start_time,0,8)))]"></remove>-->
        </processors>

    </view>


    <view name="group_availability_results_rotated">

        <info>
            <category>API results aggregated</category>
            <description>Site API results cached </description>
        </info>

        <argument name="diff">10</argument>
        <argument name="availability_profile">test-ap1</argument>
        <argument name="group_type">site</argument>
        <argument name="granularity">DAILY</argument>
        <argument name="start_time">0</argument>
        <argument name="end_time">0</argument>
        <!--<argument name="start_time" eval="concat(substring(date:add(date:date-time(),concat('-P',$diff+1,'M')), 0,8),'-01T00:00:00Z')"></argument>-->
        <!--<argument name="end_time" eval="concat(substring(date:add(date:date-time(),concat('-P',$diff,'M')), 0,8),'-01T00:00:00Z') "/>-->

        <argument name="starttime" eval="choose($diff=10,$start_time,concat(substring(date:add(date:date-time(),concat('-P',$diff+1,'M')), 0,8),'-01T00:00:00Z'))"></argument>
        <argument name="endtime" eval="choose($diff=10,$end_time,concat(substring(date:add(date:date-time(),concat('-P',$diff,'M')), 0,8),'-01T00:00:00Z'))"></argument>






        <connector type="RotatingCacheConnector">
            <parameter name="content" eval="
            view(choose($group_type!='service','group_availability_results','services_availability_results'),
            entry('availability_profile',$availability_profile)
            |entry('group_type',$group_type)
            |entry('granularity',$granularity)
            |entry('start_time',$starttime)
             |entry('end_time',$endtime)
             )"/>
            <parameter name="key" eval="concat($availability_profile,'-',$group_type,'-',$granularity,'-',$starttime,'-',$endtime)"/>
            <parameter name="size">100000</parameter>
        </connector>


    </view>










    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="listNgi">

        <info>
            <description>GOC DB : List of Ngi</description>
            <category>GOC DB</category>
        </info>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('goc.siteList')/results/SITE[not(ROC/text()=preceding-sibling::SITE/ROC/text())]/ROC/text()"/>
        </connector>

        <!--<processors>-->
            <!--<replace match="/e:entries/e:entry/text()" nodes="concat('&quot;',text(),'&quot;,')"/>-->
        <!--</processors>-->


    </view>



    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="listSite">
        <info>
            <description>GOC DB : List of Sites</description>
            <category>GOC DB</category>
        </info>


        <connector type="XMLConnector">
            <parameter name="content" eval="view('goc.siteList')/results/SITE[not(@NAME=preceding-sibling::SITE/@NAME)]/@NAME"/>
        </connector>




    </view>

    <view xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd" name="listSitesbyNgi">
        <info>
            <description>GOC DB : List of Sites per Ngi</description>
            <category>GOC DB</category>
        </info>


        <connector type="XMLConnector">
            <parameter name="content" eval="view('goc.siteList')"/>
        </connector>


        <processors>

            <element in="results">
                <element in="SITE">
                    <attribute-create out="key">../ROC/text()</attribute-create>
                    <element-ignore/>
                </element>
            </element>
            <element in="results">
                <element-ignore/>
                <element-create>sort_by_string(../SITE, '@key')</element-create>
            </element>
            <element in="results">
                <element-create-as-parent out="Ngi" group-by="@key" attributes="@key">
                    <element in="SITE">
                        <attribute-ignore in="key"/>
                    </element>
                </element-create-as-parent>
            </element>
        </processors>


    </view>

    <view name="goc.siteList">
        <info>
            <description>GOC DB : List of Raw Sites</description>
            <category>GOC DB</category>
        </info>

    <connector type="HTTPConnector">
        <parameter name="url" eval="property('goc.siteList')"></parameter>
        <parameter name="certificate" eval="property('certificate.path')"/>
        <parameter name="passphrase" eval="property('certificate.password')"/>
        <parameter name="force-redirect">true</parameter>
    </connector>

    <cache type="FileCache">
        <!--<trigger type="ViewCreatedTrigger"/>-->
        <trigger type="DeltaTimeTrigger">
            <parameter name="hours">4</parameter>
        </trigger>
        <trigger type="ViewNotifiedTrigger"/>
        <trigger type="ViewCreatedTrigger"/>
    </cache>

</view>


    <view name="listParameters">

        <info>
            <description>list of parameters from the form</description>
            <category>Form</category>
        </info>

        <argument name="mode">light</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('listProfilesRaw')"></parameter>
        </connector>

        <processors>

            <insert match="/root" nodes="new_element('ngis')"></insert>
            <insert match="/root" nodes="new_element('sites')"></insert>
            <insert match="/root" nodes="new_element('hosts')"></insert>
            <insert match="/root/ngis" nodes="view('listNgi')"></insert>
            <insert match="/root/sites" nodes="view('listSite')"></insert>
            <insert match="/root/hosts" nodes="view('goc.HostList')"></insert>

            <replace match="/root/ngis/e:entries/e:entry/text()" nodes="concat(',',.)"></replace>
            <replace match="/root/sites/e:entries/e:entry/text()" nodes="concat(',',.)"></replace>
            <replace match="/root/hosts/e:entries/e:entry/text()" nodes="concat(',',.)"></replace>

            <remove match="/root/ngis/e:entries" depth="2"></remove>
            <remove match="/root/sites/e:entries" depth="2"></remove>
            <remove match="/root/hosts/e:entries" depth="2"></remove>
        </processors>

    </view>


    <view name="ngiContactsList">

        <info>
            <description>list of ngi for the form</description>
            <category>Form</category>
        </info>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('goc.ngiContactsList')"></parameter>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>


        <cache type="FileCache">
            <!--<trigger type="ViewCreatedTrigger"/>-->
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>
    </view>

    <view name="RolesUsers">
        <info>
            <description>list of ngi roles for user for the form</description>
            <category>Form</category>
        </info>
        <argument name="user"></argument>
        <connector type="XMLConnector">
            <parameter name="content" eval="view('ngiContactsList')"></parameter>

        </connector>

       <processors>
           <insert match="/results" nodes="new_attribute('user',str:concat(eval('concat(&quot;/&quot;,.)', reverse(str:split($user, ', ')))))"></insert>
           <insert match="/results/ROC/CONTACT" nodes="new_attribute('ngi',ancestor::ROC/@ROC_NAME)"/>
           <processor match="/results/ROC/CONTACT[CERTDN/text()=str:concat(eval('concat(&quot;/&quot;,.)', reverse(str:split($user, ', ')))) ]" type="SelectProcessor"></processor>
            <insert match="/e:entries/CONTACT" nodes="view('goc.siteList')/results/SITE[not(@NAME=preceding-sibling::SITE/@NAME) and ROC/text()=match()/@ngi]"></insert>
            <remove match="/e:entries/CONTACT/SITE/*"></remove>
       </processors>

    </view>



    <view name="customFactors">


        <info>
            <category>API results aggregated</category>
            <description>Custom factor display</description>
        </info>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('api.custom.factors')"></parameter>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>

        <processors>
            <insert match="/root/Factor" nodes="new_attribute('ngi',choose(view('goc.siteList')/results/SITE[@NAME=match()/@site]/ROC/text(),view('goc.siteList')/results/SITE[@NAME=match()/@site]/ROC/text(),'NA'))"></insert>

            <select match="/root/Factor">
                <group by="@ngi"></group>
            </select>



            <rename match="/root" name="nodeData"></rename>
            <!--<insert match="/nodeData" nodes="new_attribute('id','csFactor')"></insert>-->
            <rename match="/nodeData/e:entry/@key" name="id"></rename>
            <rename match="/nodeData/e:entry" name="children"></rename>
            <rename match="/nodeData/children/Factor" name="children"></rename>



            <rename match="/nodeData//@site" name="id"></rename>

            <insert match="/nodeData/children" nodes="new_attribute('color',choose(view('ngi_reports')/e:entries/e:entry/Ngi[@NGI=match()/@id]/Availability[position()=last()]/@availability,view('ngi_reports')/e:entries/e:entry/Ngi[@NGI=match()/@id]/Availability[position()=last()]/@availability,0))"></insert>
            <insert match="/nodeData/children/children" nodes="new_attribute('color',choose(view('site_reports')/e:entries/e:entry/Site[@site=match()/@id]/Availability[position()=last()]/@availability,view('site_reports')/e:entries/e:entry/Site[@site=match()/@id]/Availability[position()=last()]/@availability,0))"></insert>

            <replace match="/nodeData//children/@color" nodes="match() div 100 "/>


            <insert match="/nodeData/children" nodes="new_element('children',new_attribute('id',match()/@id)|new_attribute('Parent','EGI')|new_attribute('size',0)|new_attribute('color',0))"/>
            <insert match="/nodeData" nodes="new_element('children',new_attribute('id','EGI')|new_attribute('Parent','null')|new_attribute('size',0)|new_attribute('color',0))"/>

            <remove match="/nodeData/children" depth="1"/>
            <replace match="/nodeData/children/@ngi" nodes="new_attribute('Parent',match())"></replace>

            <element in="nodeData">
                <element-ignore in="children" if="@Parent='NA'"></element-ignore>
                <element in="children"></element>
            </element>


    </processors>
    <cache type="FileCache">
        <!--<trigger type="ViewCreatedTrigger"/>-->
        <trigger type="DeltaTimeTrigger">
            <parameter name="hours">4</parameter>
        </trigger>
        <trigger type="ViewNotifiedTrigger"/>
        <trigger type="ViewCreatedTrigger"/>
    </cache>

    <renderers>

        <renderer type="DefaultRenderer">
            <parameter name="template">/ARGO_UI/resources/html/factors2.html</parameter>

        </renderer>
        <renderer type="HTMLRenderer">
            <parameter name="template">/ARGO_UI/resources/html/factors2.html</parameter>

        </renderer>
        <renderer type="JSONRenderer">
            <parameter name="element_as_array">true</parameter>
        </renderer>
    </renderers>

    </view>






    <view name="goc.ServiceFlavours">

        <info>
            <description>GOC : Service Flavours List</description>
            <category>GOC DB</category>
        </info>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('goc.serviceFlavours')"></parameter>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>
        <cache type="FileCache">
            <!--<trigger type="ViewCreatedTrigger"/>-->
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>

    <view name="goc.HostList">
        <info>
            <description>GOC : Hostname List</description>
            <category>GOC DB</category>
        </info>

        <connector type="HTTPConnector">
            <parameter name="url" eval="property('goc.hostList')"></parameter>
            <parameter name="certificate" eval="property('certificate.path')"/>
            <parameter name="passphrase" eval="property('certificate.password')"/>
            <parameter name="force-redirect">true</parameter>
        </connector>


        <processors>
            <element in="results" out="e:entries">
                <element in="SERVICE_ENDPOINT" out="e:entry" >


                    <attribute-create out="hostname">../HOSTNAME/text()</attribute-create>
                    <attribute-create out="site">../SITENAME/text()</attribute-create>
                    <attribute-create out="ngi">../ROC_NAME/text()</attribute-create>
                    <attribute-create out="service">../SERVICE_TYPE/text()</attribute-create>
                    <element-ignore></element-ignore>
                </element>

            </element>
            <element in="e:entries">
                <element in="e:entry">
                    <attribute-ignore></attribute-ignore>
                    <text-create>concat(../@ngi,'___',../@site,'___',../@hostname,'___',../@service)</text-create>
                </element>
            </element>
        </processors>
        <cache type="FileCache">
            <!--<trigger type="ViewCreatedTrigger"/>-->
            <trigger type="DeltaTimeTrigger">
                <parameter name="hours">4</parameter>
            </trigger>
            <trigger type="ViewNotifiedTrigger"/>
            <trigger type="ViewCreatedTrigger"/>
        </cache>

    </view>

</config>