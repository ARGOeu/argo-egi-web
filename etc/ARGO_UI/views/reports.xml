<config xmlns="http://software.in2p3.fr/lavoisier/config.xsd"
        xmlns:date="http://exslt.org/dates-and-times"
        xmlns:xi="http://www.w3.org/2001/XInclude"
        xmlns:str="http://exslt.org/strings"
        xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">

    <view name="ngi_reports_cached">
    <info>
        <category>Display</category>
        <description>NGI League Reports - cache Rotated</description>
    </info>

    <connector type="XMLConnector">
        <parameter name="content" eval="new_element('root')"></parameter>
    </connector>

        <processors>
            <insert match="/root" nodes="
            view('group_availability_results_rotated',entry('group_type','ngi')|entry('granularity','MONTHLY')|entry('diff','0'))
            |view('group_availability_results_rotated',entry('group_type','ngi')|entry('granularity','MONTHLY')|entry('diff','1'))
            |view('group_availability_results_rotated',entry('group_type','ngi')|entry('granularity','MONTHLY')|entry('diff','2'))">

            </insert>
        </processors>

    </view>

    <!--<argument name="diff">1</argument>-->
    <!--<argument name="availability_profile">test-ap1</argument>-->
    <!--<argument name="group_type">site</argument>-->
    <!--<argument name="granularity">DAILY</argument>-->


    <view name="ngi_reports">
        <info>
            <category>Display</category>
            <description>NGI League Reports</description>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('ngi_reports_cached')"></parameter>
        </connector>

        <processors>

            <select match="/root/root/Profile"></select>
            <remove match="/e:entries/Profile" depth="1"></remove>



            <select match="/e:entries/Ngi[*]">
                <group by="@NGI" sort="text"></group>
            </select>


            <insert-parent match="/e:entries/e:entry/Ngi" name="Ngi"></insert-parent>

           <merge match="/e:entries/e:entry/Ngi"></merge>
            <remove match="/e:entries/e:entry/Ngi/Ngi" depth="1"></remove>



            <insert match="/e:entries" nodes="new_attribute('month4',substring(date:add(date:date-time(),'-P1D'),  0,8))|new_attribute('month3',substring(date:add(date:date-time(),'-P1M'),  0,8))|new_attribute('month2',substring(date:add(date:date-time(),'-P2M'),  0,8))|new_attribute('month1',substring(date:add(date:date-time(),'-P3M'),  0,8))"></insert>

            <insert match="/e:entries"  nodes="new_attribute('description','NGI League Report')"></insert>
            <insert match="/e:entries" nodes="new_attribute('details','site_reports')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('view','ngi_reports')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('related_view','ngi_ar')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('ngi','all')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('poems','ch.cern.sam.ROC_CRITICAL')"></insert>



            <element in="e:entries" if="@ngi='all'">
                <set variable="last">0</set>
                <element in="e:entry" future="true">
                    <set variable="last">.</set>
                </element>
                <element-create as="last-child">entries($last)</element-create>
            </element>

            <element in="e:entries" if="@ngi='all'">
                <element-ignore in="e:entries">
                    <element in="e:entry">
                        <attribute in="key">'EGI'</attribute>
                        <element in="Ngi">
                            <attribute in="NGI">'EGI'</attribute>
                            <element in="Availability">
                                <attribute in="availability">(sum(/e:entries/e:entry/Ngi[@NGI!='EGI']/Availability[@timestamp=current()/../@timestamp]/@availability)) div count(/e:entries/e:entry/Ngi[@NGI!='EGI']/Availability[@timestamp=current()/../@timestamp]/@availability) </attribute>
                                <attribute in="reliability">(sum(/e:entries/e:entry/Ngi[@NGI!='EGI']/Availability[@timestamp=current()/../@timestamp]/@reliability)) div count(/e:entries/e:entry/Ngi[@NGI!='EGI']/Availability[@timestamp=current()/../@timestamp]/@reliability) </attribute>
                            </element>
                        </element>
                    </element>

                </element-ignore>

            </element>

        </processors>

        <pre-renderers>
            <title>/e:entries/@description</title>
                <field label="month1">/e:entries/@month1</field>
                <field label="month2">/e:entries/@month2</field>
                <field label="month3">/e:entries/@month3</field>

            <row foreach="/e:entries/e:entry/Ngi/Availability[@timestamp=/e:entries/@month1 or @timestamp=/e:entries/@month2 or @timestamp=/e:entries/@month3]">
                <column label="Ngi">ancestor::Ngi/@NGI</column>
                <column label="Timestamp">@timestamp</column>
                <column label="Availability" unit="percentage">@availability</column>
                <column label="Reliability" unit="percentage">@reliability</column>
            </row>
        </pre-renderers>
        <renderers>
            
            <renderer type="DefaultRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="ChartRenderer">

                <parameter name="axis">inverted</parameter>
                <!--optional: The width of the chart (Integer)-->
                <parameter name="width">1200</parameter>


                <!--optional: The height of the chart (Integer)-->
                <parameter name="height">2000</parameter>
            </renderer>
        </renderers>
    </view>


    <view name="opsmon_reports">
        <info>
            <category>Display</category>
            <description>NGI League Reports</description>
        </info>

        <argument name="ngi">all</argument>


        <connector type="XMLConnector">
            <parameter name="content" eval="view('site_reports_cached',entry('availability_profile','egi-ops-monitor-critical'))"></parameter>
        </connector>

        <processors>




            <select match="/root/root/Profile"></select>
            <processor match="/e:entries/Profile/Site[@NGI!=$ngi]" type="RemoveProcessor" disabled="$ngi='all'"></processor>

            <remove match="/e:entries/Profile" depth="1"></remove>



            <select match="/e:entries/Site[*]">
                <group by="@site" sort="text"></group>
            </select>

            <insert-parent match="/e:entries/e:entry/Site" name="Site"></insert-parent>

            <merge match="/e:entries/e:entry/Site"></merge>
            <remove match="/e:entries/e:entry/Site/Site" depth="1"></remove>
            <remove match="/e:entries/e:entry" depth="1"/>
            <select match="/e:entries/Site[*]">
                <group by="@NGI" sort="text"></group>
            </select>




            <insert match="/e:entries"  nodes="new_attribute('month4',substring(date:add(date:date-time(),'-P1D'),  0,8))|new_attribute('month3',substring(date:add(date:date-time(),'-P1M'),  0,8))|new_attribute('month2',substring(date:add(date:date-time(),'-P2M'),  0,8))|new_attribute('month1',substring(date:add(date:date-time(),'-P3M'),  0,8))"></insert>

            <insert match="/e:entries"  nodes="new_attribute('description','OpsMon Report')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('view','opsmon_reports')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('ngi',$ngi)"></insert>
            <insert match="/e:entries"  nodes="new_attribute('related_view','opsmon_ar')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('poems','ch.cern.sam-OPS_MONITOR_CRITICAL')"></insert>
        </processors>

        <pre-renderers>
            <title>/e:entries/@description</title>
            <field label="month1">/e:entries/@month1</field>
            <field label="month2">/e:entries/@month2</field>
            <field label="month3">/e:entries/@month3</field>

            <row foreach="/e:entries/e:entry/Site/Availability[@timestamp=/e:entries/@month1 or @timestamp=/e:entries/@month2 or @timestamp=/e:entries/@month3]">
                <column label="Site">ancestor::Site/@site</column>
                <column label="Ngi">ancestor::Site/@NGI</column>
                <column label="Timestamp">@timestamp</column>
                <column label="Availability" unit="percentage">@availability</column>
                <column label="Reliability" unit="percentage">@reliability</column>
            </row>
        </pre-renderers>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="ChartRenderer">
                <parameter name="rotation">-45</parameter>

            </renderer>
        </renderers>

    </view>


    <view name="cloud_reports">
        <info>
            <category>Display</category>
            <description>NGI League Reports</description>
        </info>

        <argument name="ngi">all</argument>


        <connector type="XMLConnector">
            <parameter name="content" eval="view('site_reports_cached',entry('availability_profile','egi-fedcloud'))"></parameter>
        </connector>

        <processors>




            <select match="/root/root/Profile"></select>
            <processor match="/e:entries/Profile/Site[@NGI!=$ngi]" type="RemoveProcessor" disabled="$ngi='all'"></processor>

            <remove match="/e:entries/Profile" depth="1"></remove>



            <select match="/e:entries/Site[*]">
                <group by="@site" sort="text"></group>
            </select>

            <insert-parent match="/e:entries/e:entry/Site" name="Site"></insert-parent>

            <merge match="/e:entries/e:entry/Site"></merge>
            <remove match="/e:entries/e:entry/Site/Site" depth="1"></remove>
            <remove match="/e:entries/e:entry" depth="1"/>
            <select match="/e:entries/Site[*]">
                <group by="@NGI" sort="text"></group>
            </select>




            <insert match="/e:entries"  nodes="new_attribute('month4',substring(date:add(date:date-time(),'-P1D'),  0,8))|new_attribute('month3',substring(date:add(date:date-time(),'-P1M'),  0,8))|new_attribute('month2',substring(date:add(date:date-time(),'-P2M'),  0,8))|new_attribute('month1',substring(date:add(date:date-time(),'-P3M'),  0,8))"></insert>

            <insert match="/e:entries"  nodes="new_attribute('description','EGI Federated Cloud  Report')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('view','cloud_reports')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('ngi',$ngi)"></insert>
            <insert match="/e:entries"  nodes="new_attribute('related_view','cloud_ar')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('poems','ch.cern.sam.CLOUD-MON')"></insert>
        </processors>

        <pre-renderers>
            <title>/e:entries/@description</title>
            <field label="month1">/e:entries/@month1</field>
            <field label="month2">/e:entries/@month2</field>
            <field label="month3">/e:entries/@month3</field>

            <row foreach="/e:entries/e:entry/Site/Availability[@timestamp=/e:entries/@month1 or @timestamp=/e:entries/@month2 or @timestamp=/e:entries/@month3]">
                <column label="Site">ancestor::Site/@site</column>
                <column label="Ngi">ancestor::Site/@NGI</column>
                <column label="Timestamp">@timestamp</column>
                <column label="Availability" unit="percentage">@availability</column>
                <column label="Reliability" unit="percentage">@reliability</column>
            </row>
        </pre-renderers>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="ChartRenderer">
                <parameter name="rotation">-45</parameter>

            </renderer>
        </renderers>

    </view>

    <view name="site_reports_cached">
        <info>
            <category>Display</category>
            <description>NGI League Reports - cache Rotated</description>
        </info>
        <argument name="availability_profile">test-ap1</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="new_element('root')"></parameter>
        </connector>

        <processors>
            <insert match="/root" nodes="
            view('group_availability_results_rotated',entry('group_type','site')|entry('granularity','MONTHLY')|entry('availability_profile',$availability_profile)|entry('diff','0'))
            |view('group_availability_results_rotated',entry('group_type','site')|entry('granularity','MONTHLY')|entry('availability_profile',$availability_profile)|entry('diff','1'))
            |view('group_availability_results_rotated',entry('group_type','site')|entry('granularity','MONTHLY')|entry('availability_profile',$availability_profile)|entry('diff','2'))">

            </insert>
        </processors>

    </view>

    <view name="site_reports">
        <info>
            <category>Display</category>
            <description>Site League Reports</description>
        </info>

        <argument name="ngi">all</argument>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('site_reports_cached')"></parameter>
        </connector>

        <processors>
            <select match="/root/root/Profile"></select>
            <remove match="/e:entries/Profile" depth="1"></remove>

            <select match="/e:entries/Site[*]">
                <group by="@site" sort="text"></group>
            </select>

            <insert-parent match="/e:entries/e:entry/Site" name="Site"></insert-parent>

            <merge match="/e:entries/e:entry/Site"></merge>
            <remove match="/e:entries/e:entry/Site/Site" depth="1"></remove>
            <remove match="/e:entries/e:entry" depth="1"/>
            <select match="/e:entries/Site[*]">
                <group by="@NGI" sort="text"></group>
            </select>



            <insert match="/e:entries"  nodes="new_attribute('month4',substring(date:add(date:date-time(),'-P1D'),  0,8))|new_attribute('month3',substring(date:add(date:date-time(),'-P1M'),  0,8))|new_attribute('month2',substring(date:add(date:date-time(),'-P2M'),  0,8))|new_attribute('month1',substring(date:add(date:date-time(),'-P3M'),  0,8))"></insert>

            <insert match="/e:entries"  nodes="new_attribute('description','Site League Report')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('view','site_reports')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('ngi',$ngi)"></insert>
            <insert match="/e:entries"  nodes="new_attribute('related_view','site_ar')"></insert>
            <insert match="/e:entries"  nodes="new_attribute('poems','ch.cern.sam.ROC_CRITICAL')"></insert>
        </processors>

        <pre-renderers>
            <title>/e:entries/@description</title>
            <field label="month1">/e:entries/@month1</field>
            <field label="month2">/e:entries/@month2</field>
            <field label="month3">/e:entries/@month3</field>

            <row foreach="/e:entries/e:entry/Site/Availability[@timestamp=/e:entries/@month1 or @timestamp=/e:entries/@month2 or @timestamp=/e:entries/@month3]">
                <column label="Site">ancestor::Site/@site</column>
                <column label="Ngi">ancestor::Site/@NGI</column>
                <column label="Timestamp">@timestamp</column>
                <column label="Availability" unit="percentage">@availability</column>
                <column label="Reliability" unit="percentage">@reliability</column>
            </row>
        </pre-renderers>

        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">/ARGO_UI/resources/html/reports.html</parameter>

            </renderer>
            <renderer type="ChartRenderer">
                <parameter name="rotation">-45</parameter>
            </renderer>
        </renderers>

    </view>

    <view name="report_form">
        <info>
            <category>Display</category>
            <description>Form : customized report</description>
        </info>

        <connector type="XMLConnector">
            <parameter name="content" eval="view('listParameters')"></parameter>
        </connector>


        <renderers>
        <renderer type="DefaultRenderer">
            <parameter name="template">/ARGO_UI/resources/html/form_reports.html</parameter>
           <!--
            <parameter name="parameters">
                <entry key="listNgi" eval="view('listNgi')"/>
                <entry key="listSites" eval="view('listSite')"/>
            </parameter>
-->
        </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">/ARGO_UI/resources/html/form_reports.html</parameter>



            </renderer>
        </renderers>
    </view>

    <view name="render_chart_n" xmlns:e="http://software.in2p3.fr/lavoisier/entries.xsd">
        <info>
            <category>Display</category>
            <description>Render view in chart</description>
        </info>
        <argument name="view"></argument>
        <argument name="ngi">all</argument>
        <argument name="type">availability</argument>
        <argument name="chart">false</argument>
        <connector type="XMLConnector">
            <parameter name="content" eval="view($view,arguments())"></parameter>

        </connector>

        <processors>



            <processor match="/e:entries/e:entry[@key!=$ngi]" type="RemoveProcessor" disabled="$ngi='all' or $ngi='false' "></processor>



            <processor match="//Availability[@timestamp=ancestor::chart/@month1 or @timestamp=ancestor::chart/@month2 or @timestamp=ancestor::chart/@month3]"
                       type="ReplaceProcessor"
                       disabled="$type='reliability'">
                <parameter name="nodes" eval="new_element('point',new_text(@availability))"></parameter>
            </processor>

            <processor match="//Availability[@timestamp=ancestor::chart/@month1 or @timestamp=ancestor::chart/@month2 or @timestamp=ancestor::chart/@month3]"
                       type="ReplaceProcessor"
                       disabled="$type='availability'">
                <parameter name="nodes" eval="new_element('point',new_text(@reliability))"></parameter>
            </processor>


            <elements path="e:entries">
                <attribute-create out="type">$type</attribute-create>
                <element in="e:entry">
                <element in="Ngi" out="group">
                <element in="Availability">
                    <attribute-create out="color_av" if="../@availability &gt;= 80" >'green'</attribute-create>
                    <attribute-create out="color_av" if="../@availability &lt; 80">'red'</attribute-create>
                    <attribute-create out="color_re" if="../@reliability &gt;= 85">'green'</attribute-create>
                    <attribute-create out="color_re" if="../@reliability &lt; 85">'red'</attribute-create>
                </element>
                </element>
            </element>
            </elements>


            <elements path="e:entries">
                <element in="e:entry">
                    <element in="Site" out="group">
                        <element in="Availability">
                            <attribute-create out="color_av" if="../@availability &gt;= 80" >'green'</attribute-create>
                            <attribute-create out="color_av" if="../@availability &lt; 80">'red'</attribute-create>
                            <attribute-create out="color_re" if="../@reliability &gt;= 85">'green'</attribute-create>
                            <attribute-create out="color_re" if="../@reliability &lt; 85">'red'</attribute-create>
                        </element>
                    </element>
                </element>
            </elements>
        </processors>


        <renderers>
            <renderer type="DefaultRenderer">
                <parameter name="template">/ARGO_UI/resources/html/avrecharts.html</parameter>

            </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">/ARGO_UI/resources/html/avrecharts.html</parameter>

            </renderer>
        </renderers>
    </view>

    <view name="render_chart" >
        <info>
            <category>Display</category>
            <description>Render view in chart</description>
        </info>
        <argument name="view"></argument>
        <argument name="ngi">all</argument>
        <argument name="type">availability</argument>
        <argument name="chart">false</argument>
        <connector type="XMLConnector">
            <parameter name="content" eval="view($view)"></parameter>

        </connector>

        <processors>



            <processor match="/e:entries/e:entry[@key!=$ngi]" type="RemoveProcessor" disabled="$ngi='all' or $ngi='false' "></processor>
         

            <rename match="/e:entries" name="chart"></rename>
            <rename match="/chart/e:entry/ngi" name="Ngi"></rename>
            <rename match="/chart/e:entry//availability" name="Availability"></rename>

            <insert match="/chart/e:entry/Ngi" nodes="new_element('name',new_text(@NGI))" as="first_child"/>
            <insert match="/chart/e:entry/Site" nodes="new_element('name',new_text(@site))" as="first_child"/>



            <processor match="/chart/e:entry//Availability[@timestamp=ancestor::chart/@month1 or @timestamp=ancestor::chart/@month2 or @timestamp=ancestor::chart/@month3]"
                       type="ReplaceProcessor"
                       disabled="$type='reliability'">
                <parameter name="nodes" eval="new_element('point',new_text(@availability))"></parameter>
            </processor>

            <processor match="/chart/e:entry//Availability[@timestamp=ancestor::chart/@month1 or @timestamp=ancestor::chart/@month2 or @timestamp=ancestor::chart/@month3]"
                       type="ReplaceProcessor"
                       disabled="$type='availability'">
                <parameter name="nodes" eval="new_element('point',new_text(@reliability))"></parameter>
            </processor>

            <remove match="/chart/e:entry//Availability"></remove>

            <insert-parent match="/chart/e:entry//point" name="data"></insert-parent>

            <rename match="/chart/e:entry/Ngi" name="series"></rename>

            <rename match="/chart/e:entry/Site" name="series"></rename>
            <remove match="/chart/e:entry/series/@*"></remove>
            <remove match="/chart/e:entry" depth="1"></remove>


            <insert match="/chart" nodes="new_element('categories')" as="first_child"></insert>
            <insert match="/chart[*]/categories" nodes="new_element('item',new_text(ancestor::chart/@month1))|new_element('item',new_text(ancestor::chart/@month2))|new_element('item',new_text(ancestor::chart/@month3))"></insert>





            <processor match="/chart" type="InsertProcessor" disabled="$chart='true'">
                <parameter name="nodes" eval="new_attribute('title',concat(substring-before($view,'_report'),' : ',$ngi))"></parameter>
                <parameter name="destination_as">first_child</parameter>
            </processor>

            <processor match="/chart/@*" type="RemoveProcessor" disabled="$chart='false'"/>

        </processors>

        <renderers>
        <renderer type="DefaultRenderer">
            <parameter name="template">/ARGO_UI/resources/html/charts.html</parameter>

        </renderer>
            <renderer type="HTMLRenderer">
                <parameter name="template">/ARGO_UI/resources/html/charts.html</parameter>

            </renderer>
        </renderers>
    </view>

</config>